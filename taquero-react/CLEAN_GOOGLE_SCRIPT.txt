var SHEET_NAME = 'Staff Training Records';
var TIMEZONE = 'Pacific/Auckland';

function doGet(e) {
  try {
    var sheet = getSheet();
    var data = sheet.getDataRange().getValues();
    var rows = data.slice(1);
    var staffMap = {};

    for (var i = 0; i < rows.length; i++) {
      var row = rows[i];
      var staffId = row[10];
      var status = row[9];

      if (!staffId) continue;

      if (!staffMap[staffId]) {
        staffMap[staffId] = {
          id: staffId,
          name: row[1],
          initials: row[2],
          position: row[3],
          email: row[4] || '',
          phone: row[5] || '',
          createdAt: new Date(row[0] * 1000).toISOString(),
          trainingRecords: []
        };
      }

      var trainingId = row[11];
      if (trainingId && status === 'Active') {
        staffMap[staffId].trainingRecords.push({
          id: trainingId,
          staffId: staffId,
          topic: row[6],
          trainerInitials: row[7],
          date: row[8]
        });
      }
    }

    var staffList = [];
    for (var key in staffMap) {
      staffList.push(staffMap[key]);
    }

    return createResponse({success: true, data: staffList});
  } catch (error) {
    return createResponse({success: false, error: error.toString()});
  }
}

function doPost(e) {
  try {
    var param = e.parameter;
    var action = param.action;
    var data = JSON.parse(param.data);
    var timestamp = param.timestamp || new Date().toISOString();
    var sheet = getSheet();
    var result;

    if (action === 'addStaff') {
      result = addStaff(sheet, data, timestamp);
    } else if (action === 'updateStaff') {
      result = updateStaff(sheet, data);
    } else if (action === 'deleteStaff') {
      result = deleteStaff(sheet, data);
    } else if (action === 'addTraining') {
      result = addTraining(sheet, data, timestamp);
    } else if (action === 'deleteTraining') {
      result = deleteTraining(sheet, data);
    }

    return createResponse({success: true, result: result});
  } catch (error) {
    return createResponse({success: false, error: error.toString()});
  }
}

function createResponse(obj) {
  var json = JSON.stringify(obj);
  return ContentService.createTextOutput(json).setMimeType(ContentService.MimeType.JSON);
}

function getSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  return ss.getSheetByName(SHEET_NAME);
}

function formatDate(isoDate) {
  var d = new Date(isoDate);
  var day = ('0' + d.getDate()).slice(-2);
  var month = ('0' + (d.getMonth() + 1)).slice(-2);
  var year = d.getFullYear();
  return day + '/' + month + '/' + year;
}

function addStaff(sheet, data, timestamp) {
  var unix = Math.floor(new Date(timestamp).getTime() / 1000);
  var row = [unix, data.name, data.initials, data.position, data.email || '', data.phone || '', '', '', '', 'Active', data.id, ''];
  sheet.appendRow(row);
  return {staffId: data.id};
}

function updateStaff(sheet, data) {
  var allData = sheet.getDataRange().getValues();
  for (var i = 1; i < allData.length; i++) {
    if (allData[i][10] === data.id) {
      sheet.getRange(i + 1, 2).setValue(data.name);
      sheet.getRange(i + 1, 3).setValue(data.initials);
      sheet.getRange(i + 1, 4).setValue(data.position);
      sheet.getRange(i + 1, 5).setValue(data.email || '');
      sheet.getRange(i + 1, 6).setValue(data.phone || '');
    }
  }
  return {staffId: data.id};
}

function deleteStaff(sheet, data) {
  var allData = sheet.getDataRange().getValues();
  for (var i = 1; i < allData.length; i++) {
    if (allData[i][10] === data.id) {
      sheet.getRange(i + 1, 10).setValue('Deleted');
    }
  }
  return {staffId: data.id};
}

function addTraining(sheet, data, timestamp) {
  var unix = Math.floor(new Date(timestamp).getTime() / 1000);
  var allData = sheet.getDataRange().getValues();
  var info = null;

  for (var i = 1; i < allData.length; i++) {
    if (allData[i][10] === data.staffId) {
      info = {
        name: allData[i][1],
        initials: allData[i][2],
        position: allData[i][3],
        email: allData[i][4],
        phone: allData[i][5]
      };
      break;
    }
  }

  if (!info) throw new Error('Staff not found');

  var readableDate = formatDate(data.date);
  var row = [unix, info.name, info.initials, info.position, info.email, info.phone, data.topic, data.trainerInitials, readableDate, 'Active', data.staffId, data.id];
  sheet.appendRow(row);
  return {trainingRecordId: data.id};
}

function deleteTraining(sheet, data) {
  var allData = sheet.getDataRange().getValues();
  for (var i = 1; i < allData.length; i++) {
    if (allData[i][11] === data.id) {
      sheet.getRange(i + 1, 10).setValue('Deleted');
      return {trainingRecordId: data.id};
    }
  }
  throw new Error('Training not found');
}
